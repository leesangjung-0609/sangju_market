<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Univ Attendance Manager</title>
    <link href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css" rel="stylesheet">
    <style>
        /* -----------------------------------------------------------
           ğŸ¨ THEME: Clean Text & Active Gradient
           ----------------------------------------------------------- */
        :root {
            --primary-grad: linear-gradient(120deg, #89f7fe 0%, #66a6ff 100%);
            --accent-grad: linear-gradient(to right, #6a11cb 0%, #2575fc 100%);
            
            --bg-body: #f0f2f5;
            --bg-sidebar: #ffffff;
            --text-main: #2d3748; /* í‰ì†Œ ì œëª© ìƒ‰ìƒ (ê²€ì •) */
            --text-sub: #9ca3af;  /* ì •ë³´ í…ìŠ¤íŠ¸ ìƒ‰ìƒ (ì—°í•œ íšŒìƒ‰ - ì‚¬ì§„ ì°¸ê³ ) */
            
            --primary-color: #6a11cb; /* í…Œë‘ë¦¬ìš© ë‹¨ìƒ‰ */
            --radius: 12px;
            --border-color: #e2e8f0;
        }

        * { box-sizing: border-box; }
        
        body {
            font-family: 'Pretendard', sans-serif;
            background-color: var(--bg-body);
            margin: 0; padding: 0;
            height: 100vh;
            display: flex; flex-direction: column;
            color: var(--text-main);
            overflow: hidden;
        }

        /* 1. í—¤ë” */
        header {
            background: var(--accent-grad);
            color: white;
            padding: 0 30px; 
            height: 60px;
            display: flex; align-items: center; justify-content: space-between;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15); 
            z-index: 20; flex-shrink: 0;
        }
        header h1 { margin: 0; font-size: 1.3rem; font-weight: 800; letter-spacing: -0.5px; }

        /* 2. ë©”ì¸ ì»¨í…Œì´ë„ˆ */
        .container {
            display: flex;
            flex: 1; 
            overflow: hidden;
        }

        /* [ì¢Œì¸¡] ì‚¬ì´ë“œë°” */
        .sidebar {
            width: 380px; 
            background-color: var(--bg-sidebar);
            border-right: 1px solid var(--border-color);
            display: flex; flex-direction: column;
            box-shadow: 4px 0 24px rgba(0,0,0,0.02);
            z-index: 10; flex-shrink: 0;
        }

        .section-list {
            flex: 1; overflow-y: auto; padding: 20px; 
            background-color: #f8fafc;
        }
        .section-list::-webkit-scrollbar { width: 6px; }
        .section-list::-webkit-scrollbar-thumb { background: #cbd5e0; border-radius: 4px; }

        /* ----------------------------------------------------
           âœ¨ [ìµœì¢…] ë¦¬ìŠ¤íŠ¸ ì•„ì´í…œ ë””ìì¸ (ì‚¬ì§„ ìŠ¤íƒ€ì¼) âœ¨
           ---------------------------------------------------- */
        .section-item {
            background: white; 
            padding: 20px; 
            margin-bottom: 12px;
            border-radius: var(--radius); 
            cursor: pointer; 
            border: 1px solid transparent;
            box-shadow: 0 2px 5px rgba(0,0,0,0.02);
            transition: all 0.2s ease;
            position: relative; 
            overflow: hidden;
        }

        .section-item:hover { 
            transform: translateY(-2px); 
            box-shadow: 0 8px 15px rgba(0,0,0,0.06); 
        }

        /* ì„ íƒëœ ìƒíƒœ: ì™¼ìª½ ë°” & í…Œë‘ë¦¬ */
        .section-item.active { 
            background: white; 
            border: 2px solid var(--primary-color);
            box-shadow: 0 4px 12px rgba(106, 17, 203, 0.15); 
        }
        .section-item.active::before { 
            content: ''; position: absolute; 
            left: 0; top: 0; bottom: 0; width: 6px; 
            background: var(--accent-grad); 
        }

        /* 1. ì œëª© ìŠ¤íƒ€ì¼ */
        .sec-title {
            font-size: 1.15rem; 
            font-weight: 800; 
            color: var(--text-main); /* í‰ì†Œ: ê²€ì •ìƒ‰ */
            margin-bottom: 6px;
            display: block;
            letter-spacing: -0.02em;
        }
        
        /* [ì¤‘ìš”] ì„ íƒëì„ ë•Œë§Œ ì œëª©ì„ ê·¸ë¼ë°ì´ì…˜ìœ¼ë¡œ ë³€ê²½ */
        .section-item.active .sec-title {
            background: var(--accent-grad);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            color: transparent;
        }

        /* 2. í•˜ë‹¨ ì •ë³´ ìŠ¤íƒ€ì¼ (ë°°ê²½ ì—†ëŠ” í…ìŠ¤íŠ¸) */
        .sec-info-text {
            color: var(--text-sub); /* íšŒìƒ‰ */
            font-size: 0.9rem;
            font-weight: 500;
            display: block;
        }

        /* ìš°ì¸¡ ë©”ì¸ ì˜ì—­ */
        .main-column {
            flex: 1;
            display: flex; flex-direction: column;
            overflow: hidden;
            background-color: #f0f4f8;
        }

        /* ìƒë‹¨ í•„í„° ë² ë„ˆ */
        .top-filter-bar {
            background-color: white;
            padding: 15px 30px;
            display: flex; align-items: center; gap: 15px;
            border-bottom: 1px solid var(--border-color);
            box-shadow: 0 2px 10px rgba(0,0,0,0.03);
            z-index: 15; flex-shrink: 0;
        }

        .filter-group { display: flex; flex-direction: column; gap: 5px; }
        .filter-group.wide { flex: 2; min-width: 140px; }
        .filter-group.narrow { flex: 1; min-width: 100px; }

        .filter-label {
            font-size: 0.75rem; font-weight: 700; color: var(--text-sub);
            text-transform: uppercase; letter-spacing: 0.05em;
        }

        /* ë“œë¡­ë‹¤ìš´ */
        select {
            width: 100%; padding: 10px 12px;
            border: 1px solid var(--border-color); border-radius: 8px;
            font-family: 'Pretendard'; font-size: 0.9rem; font-weight: 600; color: var(--text-main);
            background-color: white; cursor: pointer; outline: none;
            appearance: none; -webkit-appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%232575fc' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3Cpolyline points='6 9 12 15 18 9'%3e%3C/polyline%3e%3C/svg%3e");
            background-repeat: no-repeat; background-position: right 10px center; background-size: 16px;
            transition: all 0.2s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.02);
        }
        select:hover:not(:disabled) { border-color: #b3c5ef; background-color: #f8fbff; }
        select:focus { border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(106, 17, 203, 0.15); }
        select:disabled { background-color: #f1f5f9; color: #94a3b8; cursor: not-allowed; background-image: none; }

        .btn-reset {
            margin-top: auto; padding: 10px 20px; height: 42px;
            background-color: white; border: 1px dashed #cbd5e0; border-radius: 8px;
            cursor: pointer; font-size: 0.85rem; font-weight: 700; color: var(--text-sub);
            transition: all 0.2s; white-space: nowrap;
        }
        .btn-reset:hover { background-color: #ebf8ff; color: var(--primary-color); border-color: var(--primary-color); }

        /* í•˜ë‹¨ ì»¨í…ì¸  ì˜ì—­ */
        .content-area {
            flex: 1; overflow-y: auto; padding: 40px;
            display: flex; flex-direction: column; align-items: center;
        }

        .empty-state { margin-top: 120px; text-align: center; opacity: 0.6; }
        .empty-state h2 { font-size: 1.8rem; font-weight: 800; color: #2d3748; margin-bottom: 10px; }

        #previewPanel {
            display: none; width: 100%; max-width: 950px;
            background: white; padding: 40px; border-radius: 24px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        }

        .panel-header { display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 2px solid #edf2f7; }
        
        .panel-title { display: flex; flex-direction: column; gap: 5px; }
        /* ìƒì„¸í™”ë©´ ì œëª© (í•­ìƒ ê·¸ë¼ë°ì´ì…˜) */
        .panel-title h2 { 
            margin: 0; font-size: 2rem; font-weight: 800; 
            background: var(--accent-grad); -webkit-background-clip: text; -webkit-text-fill-color: transparent; 
        }
        .panel-title p { margin: 0; color: #a0aec0; font-weight: 500; font-size: 1.1rem; }

        /* í…Œì´ë¸” */
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { padding: 12px; border-bottom: 1px solid #ddd; text-align: left; }
        th { background-color: #f7fafc; color: #718096; font-weight: 700; cursor: pointer; user-select: none; }
        th:hover { background-color: #ebf8ff; color: var(--primary-color); }
        th.sort-active { color: var(--primary-color); background-color: #ebf8ff; }

        .btn-download {
            background: var(--accent-grad); color: white; border: none; padding: 14px 28px;
            font-size: 1rem; font-weight: 700; border-radius: 12px; cursor: pointer;
            box-shadow: 0 4px 15px rgba(106, 17, 203, 0.3); transition: all 0.3s ease;
        }
        .btn-download:hover { transform: translateY(-3px); box-shadow: 0 10px 20px rgba(106, 17, 203, 0.4); }
        .sort-arrow { display: inline-block; margin-left: 5px; font-size: 0.9em; width: 10px; }
    </style>
</head>
<body>

<header>
    <h1>ğŸ“ Univ Attendance Manager</h1>
</header>

<div class="container">
    <div class="sidebar">
        <ul class="section-list" id="sectionList"></ul>
    </div>

    <div class="main-column">
        <div class="top-filter-bar">
            <div class="filter-group wide">
                <span class="filter-label">Department</span>
                <select id="deptFilter"><option value="">ì „ì²´ í•™ê³¼</option></select>
            </div>

            <div class="filter-group wide">
                <span class="filter-label">Course</span>
                <select id="courseFilter"><option value="">ì „ì²´ ê³¼ëª©</option></select>
            </div>

            <div class="filter-group narrow">
                <span class="filter-label">Year</span>
                <select id="yearFilter"><option value="">ì „ì²´</option></select>
            </div>

            <div class="filter-group narrow">
                <span class="filter-label">Semester</span>
                <select id="semFilter" disabled><option value="">ì „ì²´</option></select>
            </div>

            <button class="btn-reset" onclick="resetFilters()">Filter Reset</button>
        </div>

        <div class="content-area">
            <div id="emptyState" class="empty-state">
                <h2>ì¢Œì¸¡ ëª©ë¡ì—ì„œ ê°•ì¢Œë¥¼ ì„ íƒí•˜ì„¸ìš”</h2>
                <p>í•„í„°ë¥¼ ì´ìš©í•´ ì›í•˜ëŠ” ê°•ì¢Œë¥¼ ë¹ ë¥´ê²Œ ì°¾ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
            </div>

            <div id="previewPanel">
                <div class="panel-header">
                    <div class="panel-title">
                        <h2 id="displayTitle">Course Title</h2>
                        <p id="displayInfo">Instructor | Term</p>
                    </div>
                    
                    <form method="POST" action="/">
                        <input type="hidden" name="course_id" id="form_course_id">
                        <input type="hidden" name="sec_id" id="form_sec_id">
                        <input type="hidden" name="semester" id="form_semester">
                        <input type="hidden" name="year" id="form_year">
                        <input type="hidden" name="students_json" id="form_students_json">
                        
                        <button type="submit" class="btn-download">PDF Download</button>
                    </form>
                </div>
                <div id="tableContainer"></div>
            </div>
        </div>
    </div>
</div>

<script id="sections-data" type="application/json">
    {{ sections | tojson | safe }}
</script>

<script>
    const allSections = JSON.parse(document.getElementById('sections-data').textContent);
    
    const deptSelect = document.getElementById('deptFilter');
    const courseSelect = document.getElementById('courseFilter');
    const yearSelect = document.getElementById('yearFilter');
    const semSelect = document.getElementById('semFilter');
    const sectionList = document.getElementById('sectionList');

    let currentStudents = [];
    let sortState = { column: 0, order: 'asc' };
    let activeFetchController = null;

    window.onload = () => {
        updateDropdownOptions();
        renderList(allSections);
    };

    function handleFilterChange() {
        updateDropdownOptions();
        filterList();
    }

    function updateDropdownOptions() {
        const selDept = deptSelect.value;
        const selCourse = courseSelect.value;
        const selYear = yearSelect.value;
        const selSem = semSelect.value;

        const validForDept = allSections.filter(s => 
            (selCourse === "" || s[1] === selCourse) &&
            (selYear === "" || String(s[4]) === selYear) &&
            (selSem === "" || s[3] === selSem)
        );
        rebuildSelect(deptSelect, [...new Set(validForDept.map(s => s[7]))].sort(), selDept, "ì „ì²´ í•™ê³¼");

        const validForCourse = allSections.filter(s => 
            (selDept === "" || s[7] === selDept) &&
            (selYear === "" || String(s[4]) === selYear) &&
            (selSem === "" || s[3] === selSem)
        );
        rebuildSelect(courseSelect, [...new Set(validForCourse.map(s => s[1]))].sort(), selCourse, "ì „ì²´ ê³¼ëª©");

        const validForYear = allSections.filter(s => 
            (selDept === "" || s[7] === selDept) &&
            (selCourse === "" || s[1] === selCourse) &&
            (selSem === "" || s[3] === selSem)
        );
        rebuildSelect(yearSelect, [...new Set(validForYear.map(s => s[4]))].sort((a,b)=>b-a), selYear, "ì „ì²´");

        if (selYear === "") {
            semSelect.innerHTML = '<option value="">ì „ì²´</option>';
            semSelect.disabled = true;
        } else {
            semSelect.disabled = false;
            const validForSem = allSections.filter(s => 
                (selDept === "" || s[7] === selDept) &&
                (selCourse === "" || s[1] === selCourse) &&
                (String(s[4]) === selYear)
            );
            const allSems = ["Spring", "Summer", "Fall", "Winter"];
            const validSems = allSems.filter(sem => validForSem.some(s => s[3] === sem));
            rebuildSelect(semSelect, validSems, selSem, "ì „ì²´");
        }
    }

    function rebuildSelect(selectEl, items, currentValue, defaultText) {
        selectEl.innerHTML = `<option value="">${defaultText}</option>`;
        items.forEach(item => {
            const opt = document.createElement('option');
            opt.value = item;
            opt.innerText = item;
            selectEl.appendChild(opt);
        });
        if (currentValue && items.some(i => String(i) === currentValue)) {
            selectEl.value = currentValue;
        } else {
            selectEl.value = "";
        }
    }

    function filterList() {
        const selDept = deptSelect.value;
        const selCourse = courseSelect.value;
        const selYear = yearSelect.value;
        const selSem = semSelect.value;

        const filtered = allSections.filter(s => {
            const matchDept = (selDept === "" || s[7] === selDept);
            const matchCourse = (selCourse === "" || s[1] === selCourse);
            const matchYear = (selYear === "" || String(s[4]) === selYear);
            const matchSem = (selSem === "" || s[3] === selSem);
            return matchDept && matchCourse && matchYear && matchSem;
        });
        renderList(filtered);
    }

    deptSelect.addEventListener('change', handleFilterChange);
    courseSelect.addEventListener('change', handleFilterChange);
    yearSelect.addEventListener('change', handleFilterChange);
    semSelect.addEventListener('change', handleFilterChange);

    function resetFilters() {
        deptSelect.value = "";
        courseSelect.value = "";
        yearSelect.value = "";
        semSelect.value = "";
        updateDropdownOptions();
        filterList();

        document.getElementById('emptyState').style.display = 'block';
        document.getElementById('previewPanel').style.display = 'none';
        document.querySelectorAll('.section-item').forEach(el => el.classList.remove('active'));
    }

    // [í•µì‹¬] ë¦¬ìŠ¤íŠ¸ ë Œë”ë§: ì•Œì•½ ì œê±°, í…ìŠ¤íŠ¸ë¡œë§Œ êµ¬ì„±
    function renderList(data) {
        sectionList.innerHTML = "";
        if(data.length === 0) {
            sectionList.innerHTML = '<li style="padding:40px; text-align:center; color:#a0aec0; font-weight:600;">ì¡°ê±´ì— ë§ëŠ”<br>ê°•ì¢Œê°€ ì—†ìŠµë‹ˆë‹¤.</li>';
            return;
        }

        data.forEach(s => {
            const li = document.createElement('li');
            li.className = 'section-item';
            
            li.innerHTML = `
                <span class="sec-title">${s[1]} (Sec ${s[2]})</span>
                
                <span class="sec-info-text">
                    ${s[7]} | ${s[6] || 'Unknown'} | ${s[4]} ${s[3]}
                </span>
            `;
            
            li.onclick = () => selectSection(li, s);
            sectionList.appendChild(li);
        });
    }

    async function selectSection(element, s) {
        document.querySelectorAll('.section-item').forEach(el => el.classList.remove('active'));
        element.classList.add('active');

        document.getElementById('emptyState').style.display = 'none';
        document.getElementById('previewPanel').style.display = 'block';

        document.getElementById('displayTitle').innerText = `${s[1]} (Sec ${s[2]})`;
        document.getElementById('displayInfo').innerText = `${s[7]} | Prof. ${s[6] || 'Unknown'} | ${s[4]} ${s[3]}`;

        document.getElementById('form_course_id').value = s[0];
        document.getElementById('form_sec_id').value = s[2];
        document.getElementById('form_semester').value = s[3];
        document.getElementById('form_year').value = s[4];

        const tableContainer = document.getElementById('tableContainer');
        tableContainer.innerHTML = '<p style="text-align:center; color:#a0aec0; padding:40px; font-weight:600;">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>';

        if (activeFetchController) { activeFetchController.abort(); }
        activeFetchController = new AbortController();
        const signal = activeFetchController.signal;

        try {
            const res = await fetch("/preview", {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify({
                    course_id: s[0], sec_id: s[2], semester: s[3], year: s[4]
                }),
                signal: signal
            });
            const students = await res.json();
            
            currentStudents = students; 
            sortState = { column: 0, order: 'asc' }; 
            renderTable();

        } catch (err) {
            if (err.name !== 'AbortError') {
                console.error(err);
                tableContainer.innerHTML = '<p style="color:#e03131; text-align:center; padding:40px;">ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨</p>';
            }
        }
    }

    function sortData(columnIndex) {
        if (sortState.column === columnIndex) {
            sortState.order = sortState.order === 'asc' ? 'desc' : 'asc';
        } else {
            sortState.column = columnIndex;
            sortState.order = 'asc';
        }

        currentStudents.sort((a, b) => {
            let valA = a[columnIndex];
            let valB = b[columnIndex];

            if (!isNaN(valA) && !isNaN(valB)) {
                return sortState.order === 'asc' ? valA - valB : valB - valA;
            }
            valA = String(valA).toLowerCase();
            valB = String(valB).toLowerCase();
            if (valA < valB) return sortState.order === 'asc' ? -1 : 1;
            if (valA > valB) return sortState.order === 'asc' ? 1 : -1;
            return 0;
        });
        renderTable();
    }

    function renderTable() {
        const container = document.getElementById('tableContainer');
        if (!currentStudents || currentStudents.length === 0) {
            container.innerHTML = '<p style="text-align:center; padding:40px; color:#a0aec0;">ìˆ˜ê°• í•™ìƒ ì—†ìŒ</p>';
            document.getElementById('form_students_json').value = "[]";
            return;
        }

        const columns = ["ID", "Name", "Dept"];
        let headerHtml = '<thead><tr>';
        columns.forEach((colName, index) => {
            let activeClass = (sortState.column === index) ? 'sort-active' : '';
            let arrow = '';
            if (sortState.column === index) {
                arrow = (sortState.order === 'asc') ? '<span class="sort-arrow">â–²</span>' : '<span class="sort-arrow">â–¼</span>';
            }
            headerHtml += `<th width="${index===0?'20%':'40%'}" onclick="sortData(${index})" class="${activeClass}">${colName} ${arrow}</th>`;
        });
        headerHtml += '</tr></thead>';

        let bodyHtml = '<tbody>';
        currentStudents.forEach(stu => {
            bodyHtml += `<tr><td>${stu[0]}</td><td>${stu[1]}</td><td>${stu[2]}</td></tr>`;
        });
        bodyHtml += '</tbody>';

        container.innerHTML = `<table>${headerHtml}${bodyHtml}</table>`;
        document.getElementById('form_students_json').value = JSON.stringify(currentStudents);
    }
</script>

</body>
</html>