<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ìƒí’ˆ ìƒì„¸ - ì¤‘ê³ ë§ˆì¼“</title>
  <link rel="stylesheet" href="style.css" />

  <style>
    body {
      margin-top: 80px;
    }

    .detail-container {
      width: 80%;
      margin: 50px auto;
      display: flex;
      gap: 40px;
      align-items: flex-start;
      justify-content: center;
    }

    .detail-container img {
      width: 350px;
      height: 350px;
      object-fit: cover;
      border-radius: 10px;
      border: 1px solid #ddd;
    }

    .detail-info {
      flex: 1;
      max-width: 500px;
    }

    .detail-info h2 {
      margin-bottom: 15px;
      font-size: 24px;
    }

    .detail-info .price {
      font-size: 20px;
      font-weight: bold;
      color: #c0392b;
      margin-bottom: 20px;
    }

    .detail-info .description {
      line-height: 1.6;
      white-space: pre-line;
    }
  </style>

</head>

<body class="loading-screen">
  <script src="login_out.js"></script>
  <script src="my_info.js"></script>
  <nav>
    <div class="logo">
      <a href="main.html">Re:Born</a>
    </div>

    <div class="search-bar">
      <div class="search-container">
        <input type="text" id="searchInput" placeholder="ìƒí’ˆëª…, ì¹´í…Œê³ ë¦¬ ê²€ìƒ‰..." oninput="showHideClearButton()" />
        <button class="clear-btn" id="clearBtn" onclick="clearSearchInput()" style="display: none;">&times;</button>
      </div>
    </div>

    <ul class="menu">
      <li id="mypageMenu">
        <a href="#">ë§ˆì´ í˜ì´ì§€</a>
        <ul class="submenu" style="left: -30px;">
          <li><a href="my_info.html">ë‚´ ì •ë³´</a></li>
          <li><a href="goods_reg.html">ë“±ë¡í•œ ìƒí’ˆ ëª©ë¡</a></li>
          <li><a href="rating.html">í›„ê¸° / í‰ì </a></li>
          <li><a href="javascript:void(0);" onclick="openWithdrawPopup()">íƒˆí‡´í•˜ê¸°</a></li>
        </ul>
      </li>

      <li id="authMenu">
        <a href="#" id="authLink">ë¡œê·¸ì¸/íšŒì›ê°€ì…</a>
        <ul class="submenu" id="authSubmenu">
          <li><a href="login.html">ë¡œê·¸ì¸</a></li>
          <li><a href="signup.html">íšŒì›ê°€ì…</a></li>
        </ul>
      </li>
    </ul>
  </nav>

  <div class="detail-container">
    <img id="productImage" src="https://via.placeholder.com/350" alt="ìƒí’ˆ ì´ë¯¸ì§€">
    <div class="detail-info">
      <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px;">
        <span id="statusBadge"
          style="padding: 6px 12px; border-radius: 6px; color: white; font-size: 16px; font-weight: bold; display: none;">
        </span>
        <h2 id="productTitle" style="margin: 0;">ìƒí’ˆëª… ì˜ˆì‹œ</h2>
      </div>
      <div class="price" id="productPrice">10,000ì›</div>
      <div class="description" id="productDesc">
        ìƒí’ˆ ì„¤ëª… ì˜ˆì‹œì…ë‹ˆë‹¤.
        ìƒí’ˆ ìƒíƒœëŠ” ì–‘í˜¸í•˜ë©°, ì‚¬ìš©ê°ì€ ê±°ì˜ ì—†ìŠµë‹ˆë‹¤.
        ì§ê±°ë˜/íƒë°° ê°€ëŠ¥.
      </div>
      <div class="seller-name" id="sellerName" style="margin-top:18px; font-size:15px; color:#555; cursor:pointer;">
        íŒë§¤ì: <strong>dbì˜ì‹ </strong>
      </div>
      <div style="margin-top: 20px; display: flex; gap: 12px;">
        <!-- <button id="buyBtn"
          style="padding:12px 25px; background:#2c7be5; color:white; border:none; border-radius:6px; font-size:16px; cursor:pointer;">
          êµ¬ë§¤í•˜ê¸°
        </button> -->
        <button id="likeBtn"
          style="padding:12px 20px; background:#e74c3c; color:white; border:none; border-radius:6px; font-size:16px; cursor:pointer;">
          â™¥ ì¢‹ì•„ìš”
        </button>

        <!-- í›„ê¸° ì‘ì„± ë²„íŠ¼ ì¶”ê°€ ,ì´ë¶€ë¶„ì€ ì¶”ê°€ëœê±°ì„-->
        <button id="reviewWriteBtn"
          style="padding:12px 20px; background:#27ae60; color:white; border:none; border-radius:6px; font-size:16px; cursor:pointer;">
          í›„ê¸° ì‘ì„±
        </button>


        <button id="editBtn"
          style="padding:12px 25px; background:#2980b9; color:white; border:none; border-radius:6px; font-size:16px; cursor:pointer; display:none;">ìˆ˜ì •í•˜ê¸°</button>
      </div>
    </div>
  </div>

  <!-- 1. ğŸ”¹ ëŒ“ê¸€ í‘œì‹œ ì˜ì—­,ì¼ë‹¨ì´ê±° ë°©ê¸ˆ ë„£ì€ë¶€ë¶„ -->
  <section id="commentSection" style="width:80%; margin:40px auto;">
    <h3>ğŸ’¬ ëŒ“ê¸€</h3>
    <div id="commentList"></div>

    <textarea id="commentInput" placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”" style="width:100%; height:70px; margin-top:10px;"></textarea>
    <button id="commentSubmitBtn" style="margin-top:10px;">ëŒ“ê¸€ ì‘ì„±</button>
  </section>


  <script>
    // =========================================
    // 1. íŒì—… ë° ê²€ìƒ‰ì°½ UI ê´€ë ¨ í•¨ìˆ˜
    // =========================================
    function openWithdrawPopup() {
      const popupWidth = 500;
      const popupHeight = 650;
      const left = (window.screen.width / 2) - (popupWidth / 2);
      const top = (window.screen.height / 2) - (popupHeight / 2);
      const options = `width=${popupWidth},height=${popupHeight},left=${left},top=${top},status=no,menubar=no,toolbar=no,resizable=no`;
      window.open("withdraw.html", "withdrawPopup", options);
    }

    function clearSearchInput() {
      const searchInput = document.getElementById('searchInput');
      searchInput.value = '';
      showHideClearButton();
      searchInput.focus();
    }

    function showHideClearButton() {
      const searchInput = document.getElementById('searchInput');
      const clearBtn = document.getElementById('clearBtn');
      clearBtn.style.display = searchInput.value.length > 0 ? 'block' : 'none';
    }

    // =========================================
    // 2. ì „ì—­ ë³€ìˆ˜ ë° ì´ˆê¸°í™”
    // =========================================
    const commentList = document.getElementById("commentList");
    const commentInput = document.getElementById("commentInput");
    const commentSubmitBtn = document.getElementById("commentSubmitBtn");
    const editBtn = document.getElementById("editBtn");
    let currentUser = null; // ë¡œê·¸ì¸í•œ ì‚¬ìš©ì ì •ë³´ ì €ì¥

    // =========================================
    // 3. ì‚¬ìš©ì ë° ìƒí’ˆ ì •ë³´ ë¡œë“œ
    // =========================================

    // í˜„ì¬ ë¡œê·¸ì¸í•œ ì‚¬ìš©ì ì •ë³´ ê°€ì ¸ì˜¤ê¸° (ëŒ“ê¸€ ìˆ˜ì •/ì‚­ì œ ê¶Œí•œ í™•ì¸ìš©)
    async function loadCurrentUser() {
      try {
        const res = await fetch("/user/current", { credentials: "include" });
        if (res.ok) {
          const data = await res.json();
          currentUser = data.username;
          console.log("í˜„ì¬ ë¡œê·¸ì¸ ìœ ì €:", currentUser);
        } else {
          console.log("ë¡œê·¸ì¸ ìƒíƒœ ì•„ë‹˜");
        }
      } catch (err) {
        console.error("ì‚¬ìš©ì ì •ë³´ ë¡œë“œ ì‹¤íŒ¨", err);
      }
    }
    function openEditPopup(productId) {
      const popupWidth = 600;
      const popupHeight = 700;
      const left = (window.screen.width / 2) - (popupWidth / 2);
      const top = (window.screen.height / 2) - (popupHeight / 2);
      const options = `width=${popupWidth},height=${popupHeight},left=${left},top=${top},status=no,menubar=no,toolbar=no,resizable=no`;
      window.open(`goods_reg_form.html?id=${productId}`, "editProductPopup", options);
    }

    // ìƒí’ˆ ìƒì„¸ ì •ë³´ ë¶ˆëŸ¬ì˜¤ê¸°
    // ìƒí’ˆ ìƒì„¸ ì •ë³´ ë¶ˆëŸ¬ì˜¤ê¸°
async function loadProduct() {
      const params = new URLSearchParams(window.location.search);
      const productId = params.get("id");
      if (!productId) { alert("ìƒí’ˆ ID ì—†ìŒ"); return; }

      try {
        const res = await fetch(`/product/${productId}`, { credentials: "include" });
        if (!res.ok) throw new Error("ìƒí’ˆ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨");

        const product = await res.json();
        const isSeller = currentUser === product.username;
        
        const statusBadge = document.getElementById("statusBadge");
        if (statusBadge) {
          statusBadge.textContent = product.status; // 'íŒë§¤ì¤‘', 'ì˜ˆì•½ì¤‘' ë“± í…ìŠ¤íŠ¸ ë„£ê¸°
          statusBadge.style.display = "inline-block"; // ìˆ¨ê²¨ì§„ ë°°ì§€ ë³´ì´ê¸°

          // ìƒíƒœì— ë”°ë¼ ë°°ê²½ìƒ‰ ë³€ê²½
          switch (product.status) {
            case 'íŒë§¤ì¤‘':
              statusBadge.style.backgroundColor = '#2ecc71'; // ì´ˆë¡ìƒ‰
              break;
            case 'ì˜ˆì•½ì¤‘':
              statusBadge.style.backgroundColor = '#f39c12'; // ì£¼í™©ìƒ‰
              break;
            case 'íŒë§¤ì™„ë£Œ':
              statusBadge.style.backgroundColor = '#7f8c8d'; // íšŒìƒ‰
              break;
            default:
              statusBadge.style.backgroundColor = '#2c3e50'; // ê¸°ë³¸ìƒ‰
          }
        }

        document.getElementById("productImage").src = product.image_url;
        document.getElementById("productTitle").textContent = product.title;
        document.getElementById("productPrice").textContent = product.price.toLocaleString() + "ì›";
        document.getElementById("productDesc").textContent = product.description || "";
        document.getElementById("sellerName").innerHTML = `íŒë§¤ì: <strong>${product.username}</strong>`;

        if (isSeller) {
          editBtn.style.display = "block";
          editBtn.onclick = function () {
            openEditPopup(productId);
          };
        } else {
          editBtn.style.display = "none";
        }

        document.getElementById("likeBtn").onclick = async function () {
          // ... (ì¢‹ì•„ìš” ê¸°ëŠ¥ ì¤‘ëµ)
        };
      } catch (err) {
        console.error(err);
        alert("ìƒí’ˆ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
      }
    }


    // êµ¬ë§¤ ë²„íŠ¼ ì´ë²¤íŠ¸


    // íŒë§¤ì í´ë¦­ ì´ë²¤íŠ¸
    document.getElementById("sellerName").addEventListener("click", () => {
      window.location.href = 'seller.html';
    });

    // =========================================
    // 4. ëŒ“ê¸€ ê´€ë ¨ ë¡œì§ (ìˆ˜ì •ëœ ë¶€ë¶„)
    // =========================================

    // ëŒ“ê¸€ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
    async function loadComments() {
      const params = new URLSearchParams(window.location.search);
      const productId = params.get("id");
      if (!productId) return;

      try {
        // [ìˆ˜ì •] ë°±ì—”ë“œ ë¼ìš°í„° ê²½ë¡œì— ë§ì¶° '/product/' ì¶”ê°€
        const res = await fetch(`/comment/list/product/${productId}`, { credentials: "include" });
        const data = await res.json();

        // [ìˆ˜ì •] ë°±ì—”ë“œ ì‘ë‹µ êµ¬ì¡°({ success: true, comments: [] })ì— ë§ì¶° ë°°ì—´ ì¶”ì¶œ
        const comments = data.comments || [];

        commentList.innerHTML = ""; // ì´ˆê¸°í™”

        if (comments.length === 0) {
          commentList.innerHTML = "<p style='color:#777; padding:10px;'>ì²« ë²ˆì§¸ ëŒ“ê¸€ì„ ë‚¨ê²¨ë³´ì„¸ìš”!</p>";
          return;
        }

        comments.forEach(comment => {
          const div = document.createElement("div");
          div.classList.add("comment-item");
          div.style.borderBottom = "1px solid #eee";
          div.style.padding = "12px 0";

          div.innerHTML = `
          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:4px;">
            <strong>${comment.username}</strong>
            <span style="font-size:12px; color:#999;">${comment.created_at}</span>
          </div>
          <div class="comment-content" style="white-space: pre-wrap;">${comment.content}</div>
        `;

          // ë‚´ ëŒ“ê¸€ì¸ ê²½ìš° ìˆ˜ì •/ì‚­ì œ ë²„íŠ¼ ì¶”ê°€
          if (currentUser && currentUser === comment.username) {
            const btnGroup = document.createElement("div");
            btnGroup.style.marginTop = "6px";

            const editBtn = document.createElement("button");
            editBtn.textContent = "ìˆ˜ì •";
            editBtn.style.marginRight = "6px";
            editBtn.style.fontSize = "12px";
            editBtn.style.cursor = "pointer";
            editBtn.addEventListener("click", () => editComment(comment));

            const deleteBtn = document.createElement("button");
            deleteBtn.textContent = "ì‚­ì œ";
            deleteBtn.style.fontSize = "12px";
            deleteBtn.style.cursor = "pointer";
            deleteBtn.addEventListener("click", () => deleteComment(comment.comment_id));

            btnGroup.appendChild(editBtn);
            btnGroup.appendChild(deleteBtn);
            div.appendChild(btnGroup);
          }

          commentList.appendChild(div);
        });

      } catch (err) {
        console.error("ëŒ“ê¸€ ë¡œë“œ ì—ëŸ¬:", err);
        commentList.innerHTML = "ëŒ“ê¸€ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.";
      }
    }

    // ëŒ“ê¸€ ì‘ì„±
    commentSubmitBtn.addEventListener("click", async () => {
      const content = commentInput.value.trim();
      if (!content) return alert("ëŒ“ê¸€ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");

      const params = new URLSearchParams(window.location.search);
      const productId = params.get("id");

      try {
        const res = await fetch("/comment/add", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            product_id: productId,
            content: content
          }),
          credentials: "include" // ì„¸ì…˜ ì¿ í‚¤ í¬í•¨ í•„ìˆ˜
        });

        const result = await res.json();

        if (res.ok && result.success) {
          commentInput.value = ""; // ì…ë ¥ì°½ ë¹„ìš°ê¸°
          loadComments(); // ëª©ë¡ ê°±ì‹ 
        } else {
          alert(result.message || "ëŒ“ê¸€ ì‘ì„± ì‹¤íŒ¨ (ë¡œê·¸ì¸ì´ í•„ìš”í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤)");
        }
      } catch (err) {
        console.error(err);
        alert("ì„œë²„ í†µì‹  ì˜¤ë¥˜");
      }
    });

    // ëŒ“ê¸€ ì‚­ì œ
    async function deleteComment(commentId) {
      if (!confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

      try {
        const res = await fetch(`/comment/remove`, {
          method: "DELETE",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ comment_id: commentId }),
          credentials: "include"
        });

        const result = await res.json();
        if (result.success) {
          loadComments();
        } else {
          alert(result.message || "ì‚­ì œ ì‹¤íŒ¨");
        }
      } catch (err) {
        console.error(err);
        alert("ì‚­ì œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ");
      }
    }

    // ëŒ“ê¸€ ìˆ˜ì •
    function editComment(comment) {
      const newContent = prompt("ëŒ“ê¸€ì„ ìˆ˜ì •í•˜ì„¸ìš”:", comment.content);
      if (newContent === null) return; // ì·¨ì†Œ ëˆ„ë¦„
      if (newContent.trim() === "") return alert("ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");

      fetch(`/comment/update`, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          comment_id: comment.comment_id,
          new_content: newContent
        }),
        credentials: "include"
      })
        .then(res => res.json())
        .then(result => {
          if (result.success) {
            loadComments();
          } else {
            alert(result.message || "ìˆ˜ì • ì‹¤íŒ¨");
          }
        })
        .catch(err => {
          console.error(err);
          alert("ìˆ˜ì • ì¤‘ ì˜¤ë¥˜ ë°œìƒ");
        });
    }

    // =========================================
    // 5. í˜ì´ì§€ ì´ˆê¸°í™” ì‹¤í–‰
    // =========================================
    (async function init() {
      await loadCurrentUser(); // ì‚¬ìš©ì ì •ë³´ ë¨¼ì € ë¡œë“œ (ë²„íŠ¼ í‘œì‹œ ë¡œì§ ìœ„í•´)
      loadProduct();           // ìƒí’ˆ ì •ë³´ ë¡œë“œ
      loadComments();          // ëŒ“ê¸€ ë¡œë“œ
    })();


   // 6. í›„ê¸°ì‘ì„±ìœ¼ë¡œ ì˜®ê²¨ê°€ëŠ”í˜ì´ì§€ ê´€ë ¨ ìë°”ìŠ¤í¬ë¦½íŠ¸ í•¨ìˆ˜ì‘ì„±  
      document.getElementById("reviewWriteBtn").addEventListener("click", () => {
    const params = new URLSearchParams(window.location.search);
    const productId = params.get("id");

    if (!productId) return alert("ìƒí’ˆ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");

    window.location.href = `review_write.html?id=${productId}`;
  });


  </script>

</body>

</html>
